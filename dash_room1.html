<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bảng Nhiệt độ & Độ ẩm – HiveMQ</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 24px; background: #f8fafc; color: #0f172a; }
    .card { background: white; border-radius: 14px; box-shadow: 0 8px 24px rgba(15,23,42,.06); padding: 20px; max-width: 900px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .muted { color: #475569; font-size: 14px; }
    .status { display: inline-flex; align-items: center; gap: 8px; font-size: 14px; margin: 8px 0 16px; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #e2e8f0; }
    .dot.ok { background: #16a34a; }
    .dot.warn { background: #f59e0b; }
    .dot.err { background: #ef4444; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; background: white; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; text-align: left; font-variant-numeric: tabular-nums; }
    th { background: #f1f5f9; font-weight: 600; }
    tbody tr:hover { background: #f8fafc; }
    .rowcap { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; }
    .cfg { font-family: ui-monospace; font-size: 12px; background: #0f172a; color: #e2e8f0; border-radius: 10px; padding: 10px 12px; overflow: auto; }
    .hint { font-size: 12px; color: #64748b; margin-top: 6px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    button { border: 0; background: #0ea5e9; color: white; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .small { font-size: 12px; }

    /* Badge trạng thái chung */
    .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius: 999px; font-size: 12px; font-weight:600; background:#e2e8f0; color:#0f172a; margin-right:8px; }
    .badge .led { width:8px; height:8px; border-radius:999px; background:#94a3b8; }
    /* Relay */
    .badge.on  { background:#dcfce7; color:#065f46; }
    .badge.on  .led { background:#16a34a; }
    .badge.off { background:#fee2e2; color:#7f1d1d; }
    .badge.off .led { background:#ef4444; }
    /* Door */
    .badge.open   { background:#dbeafe; color:#1e3a8a; }
    .badge.open .led { background:#3b82f6; }
    .badge.closed { background:#e5e7eb; color:#111827; }
    .badge.closed .led { background:#64748b; }
  </style>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="BE.js"></script>
</head>
<body>
  <div class="card">
    <div class="rowcap">
      <div>
        <h1>Bảng Nhiệt độ & Độ ẩm</h1>
        <!-- Relay badge -->
        <div id="relayBadge" class="badge" title="Trạng thái relay">
          <span class="led"></span><span id="relayText">Relay: —</span>
        </div>
        <!-- >>> DOOR: Door badge -->
        <div id="doorBadge" class="badge" title="Trạng thái cửa">
          <span class="led"></span><span id="doorText">Door: —</span>
        </div>
      </div>
      <div class="controls">
        <span id="status" class="status"><span class="dot" id="dot"></span><span id="statusText">Đang khởi tạo…</span></span>
        <button id="btnClear" type="button">Xoá bảng</button>
        <button id="btnOn"  type="button" title='Gửi {"relay":1}'>Bật relay</button>
        <button id="btnOff" type="button" title='Gửi {"relay":0}'>Tắt relay</button>
      </div>
    </div>

    <table id="dataTable" aria-label="Bảng nhiệt độ và độ ẩm">
      <thead>
        <tr>
          <th>Nhiệt độ (°C)</th>
          <th>Độ ẩm (%RH)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <details style="margin-top:16px;" style="visibility: hidden">
      <summary class="muted" style="visibility: hidden">Cấu hình kết nối (bấm mở)</summary>
      <pre class="cfg" id="cfg"></pre>
      <div class="hint small">Lưu ý: Không để user/pass thật trên web công khai. Hãy dùng user read-only hoặc backend.</div>
    </details>
  </div>

<script>
(function(){
  const HOST = 'dcede8aa2beb496b980ed91f6804346e.s1.eu.hivemq.cloud';
  const PORT = 8884;              // TLS WebSocket
  const PATH = '/mqtt';
  const USERNAME = 'Huy-DTVT17B';
  const PASSWORD = 'GiaHuy2008@';

  const SUB_TOPIC   = 'coldroom/esp32-room1/rfid'; // telemetry
  const STATE_TOPIC = 'esp32/out';                  // nhận {"relay":0|1,"door":0|1}
  const PUB_TOPIC   = 'esp32/client';               // gửi lệnh {"relay":0|1}

  const cfgEl = document.getElementById('cfg');
  const maskPwd = PASSWORD.replace(/.(?=.{2}$)/g, '*');
  const clientId = 'webapp-' + Math.random().toString(16).slice(2,8);
  cfgEl.textContent = `Host: ${HOST}\nPort: ${PORT}\nPath: ${PATH}\nClientId: ${clientId}\nUsername: ${USERNAME}\nPassword: ${maskPwd}\nSubscribe: ${SUB_TOPIC}, ${STATE_TOPIC}\nPublish: ${PUB_TOPIC}`;

  const tbody = document.getElementById('tbody');
  const statusText = document.getElementById('statusText');
  const dot = document.getElementById('dot');
  const btnClear = document.getElementById('btnClear');
  const btnOn = document.getElementById('btnOn');
  const btnOff = document.getElementById('btnOff');

  const relayBadge = document.getElementById('relayBadge');
  const relayText  = document.getElementById('relayText');
  const doorBadge  = document.getElementById('doorBadge');     // >>> DOOR
  const doorText   = document.getElementById('doorText');      // >>> DOOR

  btnClear.addEventListener('click', () => { tbody.innerHTML = ''; });
  btnOn.addEventListener('click', () => publishRelay(1));
  btnOff.addEventListener('click', () => publishRelay(0));

  function setStatus(text, cls){
    statusText.textContent = text;
    dot.className = 'dot ' + (cls || '');
  }
  function setButtonsEnabled(enabled){
    btnOn.disabled = !enabled;
    btnOff.disabled = !enabled;
  }
  function publishRelay(val){
    const payload = JSON.stringify({ relay: Number(val) });
    if (client && client.connected){
      client.publish(PUB_TOPIC, payload, { qos: 0, retain: false });
      setStatus('Đã gửi ' + payload + ' → ' + PUB_TOPIC, 'ok');
    } else {
      setStatus('Chưa kết nối, không thể gửi', 'err');
    }
  }

  function updateRelayBadge(val01){
    const on = Number(val01) === 1;
    relayBadge.classList.remove('on','off');
    relayBadge.classList.add(on ? 'on' : 'off');
    relayText.textContent = 'Relay: ' + (on ? 'ON' : 'OFF');
  }
  // >>> DOOR: cập nhật huy hiệu cửa
  function updateDoorBadge(val01){
    const open = Number(val01) === 1;
    doorBadge.classList.remove('open','closed');
    doorBadge.classList.add(open ? 'open' : 'closed');
    doorText.textContent = 'Door: ' + (open ? 'OPEN' : 'CLOSED');
  }

  const url = `wss://${HOST}:${PORT}${PATH}`;
  const options = {
    clientId: 'webapp-' + Math.random().toString(16).slice(2),
    username: USERNAME,
    password: PASSWORD,
    clean: true,
    reconnectPeriod: 2000,
    connectTimeout: 15000,
    keepalive: 60,
    protocolVersion: 4,
  };

  setStatus('Đang kết nối…', 'warn');
  setButtonsEnabled(false);
  const client = mqtt.connect(url, options);

  client.on('connect', () => {
    setStatus('Đã kết nối', 'ok');
    setButtonsEnabled(true);
    client.subscribe([SUB_TOPIC, STATE_TOPIC], { qos: 0 }, (err) => {
      if (err) setStatus('Lỗi subscribe: ' + err.message, 'err');
    });
  });
  client.on('reconnect', () => { setStatus('Đang thử kết nối lại…', 'warn'); setButtonsEnabled(false); });
  client.on('close', () => { setStatus('Mất kết nối', 'err'); setButtonsEnabled(false); });
  client.on('error', (err) => setStatus('Lỗi: ' + err.message, 'err'));

  client.on('message', (topic, payload) => {
    const msg = payload.toString().trim();

    if (topic === STATE_TOPIC) {
      try {
        const obj = JSON.parse(msg);
        // Relay
        if (obj.relay !== undefined) {
          const rv = (obj.relay === true) ? 1 : (obj.relay === false) ? 0 : Number(obj.relay);
          if (rv === 0 || rv === 1) updateRelayBadge(rv);
        }
        // >>> DOOR
        if (obj.door !== undefined) {
          const dv = (obj.door === true) ? 1 : (obj.door === false) ? 0 : Number(obj.door);
          if (dv === 0 || dv === 1) updateDoorBadge(dv);
        }
      } catch (e) {
        console.warn('STATE JSON error:', msg);
      }
      return;
    }

    if (topic === SUB_TOPIC) {
      let t = null, h = null;
      try {
        const obj = JSON.parse(msg);
        t = obj.temp ?? obj.temperature ?? obj.T ?? null;
        h = obj.humi ?? obj.humidity ?? obj.H ?? null;
      } catch(_) {
        const parts = msg.split(/[;,\s]+/).filter(Boolean);
        if (parts.length >= 2) {
          t = parseFloat(parts[0]);
          h = parseFloat(parts[1]);
        }
      }
      if (Number.isFinite(t) && Number.isFinite(h)) {
        appendRow(t, h);
      } else {
        console.warn('Không phân tích được dữ liệu:', msg);
      }
    }
  });

  function appendRow(temp, humi) {
    const tr = document.createElement('tr');
    const tdT = document.createElement('td');
    const tdH = document.createElement('td');
    tdT.textContent = Number(temp).toFixed(1);
    tdH.textContent = Number(humi).toFixed(1);
    tr.appendChild(tdT);
    tr.appendChild(tdH);
    tbody.insertBefore(tr, tbody.firstChild);
    while (tbody.rows.length > 1) tbody.deleteRow(-1);
  }
})();
</script>
</body>
</html>
