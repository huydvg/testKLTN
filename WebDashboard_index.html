<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H·ªÜ TH·ªêNG GI√ÅM S√ÅT QU·∫¢N L√ù PH√íNG KHO L·∫†NH</title>

  <link rel="stylesheet" href="./WebDashboard_styles.css" />

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

</head>

<body>
  <div class="container">
    <header>
      <h1>H·ªÜ TH·ªêNG GI√ÅM S√ÅT QU·∫¢N L√ù PH√íNG KHO L·∫†NH</h1>
      <div class="pill hidden" id="hdrWrap" hidden>
        <span id="hdrDot" class="dot"></span>
        <span id="hdrSt">ƒêang kh·ªüi t·∫°o‚Ä¶</span>
      </div>
    </header>

    <div class="tabs">
      <button id="tabRFIDBtn" class="tabbtn">üì∂ Qu·∫£n l√Ω h√†ng h√≥a</button>
      <button id="tabRoomBtn" class="tabbtn">üå°Ô∏è Ph√≤ng l·∫°nh</button>
      <button id="tabReportBtn" class="tabbtn">üìä Google Sheet</button>
    </div>

    <!-- ===== RFID ===== -->
    <section id="tabRFID" class="section">
      <div class="card">
        <div class="toolbar">
          <span class="pill  hidden">Broker: <code id="rfidBroker" class="mono"></code></span>
          <span class="pill hidden">Topic: <code id="rfidTopic" class="mono"></code></span>

          <span class="pill">T·ªïng b·∫£n tin: <b id="rfidCnt">0</b></span>

          <button id="btnRFIDClear">Xo√° b·∫£ng</button>
          <button id="btnRFIDClearScreen" title="Ch·ªâ xo√° ph·∫ßn hi·ªÉn th·ªã hi·ªán t·∫°i, kh√¥ng xo√° d·ªØ li·ªáu ƒë√£ l∆∞u">Xo√° ch·ªâ tr√™n
            m√†n h√¨nh</button>
          <button id="btnRFIDRestore" class="primary" title="V·∫Ω l·∫°i t·ª´ d·ªØ li·ªáu ƒë√£ l∆∞u">Kh√¥i ph·ª•c hi·ªÉn th·ªã</button>
          <button id="btnRFIDCSV" class="primary">Xu·∫•t CSV</button>

          <input id="rfidSearch" placeholder="T√¨m t√™n h√†ng" />
        </div>

        <div class="rfidStats" id="rfidStats">
          <div class="rfidStat">
            <div class="rfidStatLabel">H√†ng ƒëang trong kho</div>
            <div class="rfidStatValue" id="rfidInStockCount">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">An to√†n (‚â• 14 ng√†y)</div>
            <div class="rfidStatValue" id="rfidSafeCount">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">C·∫ßn theo d√µi (7‚Äì13 ng√†y)</div>
            <div class="rfidStatValue" id="rfidWatchCount">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">S·∫Øp / ƒë√£ h·∫øt h·∫°n (‚â§ 6 ng√†y)</div>
            <div class="rfidStatValue" id="rfidDangerCount">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">L∆∞·ª£t IN h√¥m nay</div>
            <div class="rfidStatValue" id="rfidInToday">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">L∆∞·ª£t OUT h√¥m nay</div>
            <div class="rfidStatValue" id="rfidOutToday">0</div>
          </div>

          <div class="rfidStat">
            <div class="rfidStatLabel">Ph√≤ng 1 trong kho</div>
            <div class="rfidStatValue" id="rfidRoom1InStock">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">Ph√≤ng 2 trong kho</div>
            <div class="rfidStatValue" id="rfidRoom2InStock">0</div>
          </div>
          <div class="rfidStat">
            <div class="rfidStatLabel">Ph√≤ng 3 trong kho</div>
            <div class="rfidStatValue" id="rfidRoom3InStock">0</div>
          </div>
        </div>

        <div class="filterRow">
          <span style="font-size:16px;color:var(--muted)">L·ªçc HSD:</span>
          <button type="button" class="filterChip active" data-hsd="all" id="hsdFilterAll">T·∫•t c·∫£</button>
          <button type="button" class="filterChip" data-hsd="safe" id="hsdFilterSafe">An to√†n</button>
          <button type="button" class="filterChip" data-hsd="watch" id="hsdFilterWatch">C·∫ßn theo d√µi</button>
          <button type="button" class="filterChip" data-hsd="danger" id="hsdFilterDanger">S·∫Øp / ƒë√£ h·∫øt h·∫°n</button>
          <span class="filterSwitch">
            <input type="checkbox" id="onlyInStock">
            <label for="onlyInStock">Ch·ªâ hi·ªÉn th·ªã h√†ng ƒëang trong kho</label>
          </span>
        </div>

        <div class="filterRow">
          <span style="font-size:16px;color:var(--muted)">Ph√≤ng:</span>
          <button type="button" class="filterChip active" data-room="all" id="roomFilterAll">T·∫•t c·∫£</button>
          <button type="button" class="filterChip" data-room="room1" id="roomFilter1">Ph√≤ng 1</button>
          <button type="button" class="filterChip" data-room="room2" id="roomFilter2">Ph√≤ng 2</button>
          <button type="button" class="filterChip" data-room="room3" id="roomFilter3">Ph√≤ng 3</button>
        </div>

        <div class="tabs" style="padding:0 12px 8px 12px;border-bottom:1px solid var(--border);margin-top:0">
          <button id="rfidSubTodayBtn" class="tabbtn small">H√¥m nay</button>
          <button id="rfidSubHistoryBtn" class="tabbtn small">L·ªãch s·ª≠</button>
        </div>

        <div id="rfidPaneToday" class="rfidPane">
          <table aria-label="B·∫£ng RFID h√¥m nay">
            <thead>
              <tr>
                <th style="width:6%">STT</th>
                <th style="width:18%">T√™n h√†ng h√≥a</th>
                <th style="width:10%">Ph√≤ng</th>
                <th style="width:10%">Nhi·ªát ƒë·ªô b·∫£o qu·∫£n</th>
                <th style="width:10%">Tr·∫°ng th√°i nh·∫≠p xu·∫•t</th>
                <th style="width:12%">Ng√†y/th√°ng/nƒÉm</th>
                <th style="width:10%">Th·ªùi gian</th>
                <th style="width:12%">Ng√†y s·∫£n xu·∫•t</th>
                <th style="width:12%">H·∫°n s·ª≠ d·ª•ng</th>
                <th class="stayCol">Th·ªùi gian ƒë√£ ·ªü trong kho</th>
                <th class="expireCol">Th·ªùi gian s·∫Øp qu√° h·∫°n</th>
              </tr>
            </thead>
            <tbody id="rfidTbodyToday"></tbody>
          </table>
        </div>

        <div id="rfidPaneHistory" class="rfidPane">
          <div style="padding:10px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span>Ch·ªçn ng√†y:</span>
            <select id="rfidHistoryDaySel">
              <option value="">(Ch∆∞a c√≥ l·ªãch s·ª≠)</option>
            </select>
          </div>
          <table aria-label="B·∫£ng RFID l·ªãch s·ª≠">
            <thead>
              <tr>
                <th style="width:6%">STT</th>
                <th style="width:18%">T√™n h√†ng h√≥a</th>
                <th style="width:10%">Ph√≤ng</th>
                <th style="width:10%">Nhi·ªát ƒë·ªô b·∫£o qu·∫£n</th>
                <th style="width:10%">Tr·∫°ng th√°i nh·∫≠p xu·∫•t</th>
                <th style="width:12%">Ng√†y/th√°ng/nƒÉm</th>
                <th style="width:10%">Th·ªùi gian</th>
                <th style="width:12%">Ng√†y s·∫£n xu·∫•t</th>
                <th style="width:12%">H·∫°n s·ª≠ d·ª•ng</th>
                <th class="stayCol">Th·ªùi gian ƒë√£ ·ªü trong kho</th>
                <th class="expireCol">Th·ªùi gian s·∫Øp qu√° h·∫°n</th>
              </tr>
            </thead>
            <tbody id="rfidTbodyHistory"></tbody>
          </table>
        </div>

        <div class="footer hidden">
          <small>Gi·ªØ t·ªëi ƒëa <span class="mono" id="rfidMax">200</span> d√≤ng (m·ªõi nh·∫•t ·ªü tr√™n).</small>
          <small class="mono hidden">MQTT 3.1.1 / WebSocket TLS</small>
        </div>
      </div>
    </section>

    <!-- ===== ROOM ===== -->
    <section id="tabRoom" class="section">
      <div class="card">
        <div class="toolbar" style="justify-content:space-between">
          <div class="controls hidden">
            <span class="pill">Broker: <code id="roomBroker" class="mono"></code></span>
            <span class="pill">Sub: <code id="roomSub" class="mono"></code></span>
            <span class="pill">State: <code id="roomState" class="mono"></code></span>
            <span class="pill">Pub: <code id="roomPub" class="mono"></code></span>
          </div>

          <div class="controls">
            <div class="roomtabs">
              <span>Ph√≤ng:</span>
              <button class="roombtn active" data-room="room1">Ph√≤ng 1</button>
              <button class="roombtn" data-room="room2">Ph√≤ng 2</button>
              <button class="roombtn" data-room="room3">Ph√≤ng 3</button>
            </div>

            <button id="btnAllRooms" type="button" class="tagbtn"
              title="Hi·ªÉn th·ªã nhi·ªát ƒë·ªô/ƒë·ªô ·∫©m c·ªßa c·∫£ 3 ph√≤ng c√πng l√∫c">
              üßä Hi·ªÉn th·ªã 3 ph√≤ng
            </button>

            <button id="btnOpenTHLog" class="tabbtn small">üìã B·∫£ng ghi nhi·ªát ƒë·ªô/ƒë·ªô ·∫©m</button>

            <div id="doorBadge" class="badge" title="Tr·∫°ng th√°i c·ª≠a">
              <span class="dot"></span><span id="doorText">Door: ‚Äî</span>
            </div>

            <div class="toggleRow"
              title="OFF: t·∫Øt to√†n b·ªô h·ªá th·ªëng ph√≤ng n√†y (relay, oled, dht, c·ª≠a, peltier...). Web c≈©ng kho√° ƒëi·ªÅu khi·ªÉn c·ªßa ph√≤ng ƒë√≥.">
              <span class="toggleLabel">B·∫≠t h·ªá th·ªëng</span>

              <label class="toggle">
                <input type="checkbox" id="roomSysEnable">
                <span class="track"></span> 
                <span class="thumb"></span>
              </label>
            </div>

            <div class="toggleRow"
              title="T·∫Øt -> Web ·∫©n c·∫£nh b√°o + g·ª≠i l·ªánh xu·ªëng ESP32 ƒë·ªÉ t·∫Øt c√≤i/b√°o ƒë·ªông ph·∫ßn c·ª©ng (theo ph√≤ng)">
              <span class="toggleLabel">C·∫£nh b√°o</span>

              <label class="toggle">
                <input type="checkbox" id="alarmEnableWeb">
                <span class="track"></span>`
                <span class="thumb"></span>
              </label>
            </div>


            <div id="alarmBadge" class="badge hidden" title="C·∫£nh b√°o nhi·ªát ƒë·ªô">
              <span id="alarmDot" class="dot"></span><span id="alarmText">B√ÅO ƒê·ªòNG NHI·ªÜT ƒê·ªò: ‚Äî</span>
            </div>
            <div id="alarmLED" class="led hidden" title="Nhi·ªát ƒë·ªô v∆∞·ª£t ng∆∞·ª°ng" aria-label="Alarm"></div>
          </div>
        </div>

        <!-- hi·ªÉn th·ªã 3 ph√≤ng -->
        <div id="allRoomsWrap" class="allRoomsWrap hidden">
          <div class="allRoomsGrid">
            <div class="roomMiniCard" id="mini_room1">
              <div class="roomMiniTitle">
                <span>Ph√≤ng 1</span>
                <span class="roomMiniMeta" id="mini_room1_meta">‚Äî</span>
              </div>
              <div class="roomMiniVals">
                <div class="roomMiniValBox">
                  <div class="roomMiniValLabel">Nhi·ªát ƒë·ªô</div>
                  <div class="roomMiniVal"><span id="mini_room1_t">--.-</span> <span class="roomMiniValUnit">¬∞C</span>
                  </div>
                </div>
                <div class="roomMiniValBox">
                  <div class="roomMiniValLabel">ƒê·ªô ·∫©m</div>
                  <div class="roomMiniVal"><span id="mini_room1_h">--.-</span> <span class="roomMiniValUnit">%RH</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="roomMiniCard" id="mini_room2">
              <div class="roomMiniTitle">
                <span>Ph√≤ng 2</span>
                <span class="roomMiniMeta" id="mini_room2_meta">‚Äî</span>
              </div>
              <div class="roomMiniVals">
                <div class="roomMiniValBox">
                  <div class="roomMiniValLabel">Nhi·ªát ƒë·ªô</div>
                  <div class="roomMiniVal"><span id="mini_room2_t">--.-</span> <span class="roomMiniValUnit">¬∞C</span>
                  </div>
                </div>
                <div class="roomMiniValBox">
                  <div class="roomMiniValLabel">ƒê·ªô ·∫©m</div>
                  <div class="roomMiniVal"><span id="mini_room2_h">--.-</span> <span class="roomMiniValUnit">%RH</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="roomMiniCard" id="mini_room3">
              <div class="roomMiniTitle">
                <span>Ph√≤ng 3</span>
                <span class="roomMiniMeta" id="mini_room3_meta">‚Äî</span>
              </div>
              <div class="roomMiniVals">
                <div class="roomMiniValBox">
                  <div class="roomMiniValLabel">Nhi·ªát ƒë·ªô</div>
                  <div class="roomMiniVal"><span id="mini_room3_t">--.-</span> <span class="roomMiniValUnit">¬∞C</span>
                  </div>
                </div>
                <div class="roomMiniValBox">
                  <div class="roomMiniValLabel">ƒê·ªô ·∫©m</div>
                  <div class="roomMiniVal"><span id="mini_room3_h">--.-</span> <span class="roomMiniValUnit">%RH</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid hidden" id="relayGrid"></div>

        <div class="peltierBar">
          <span class="pill hidden">Peltier CMD: <code class="mono" id="pelCmdTopic"></code></span>
          <span class="pill hidden">State: <code class="mono" id="pelStateTopic"></code></span>
          <span class="pill hidden">Tele: <code class="mono" id="pelTeleTopic"></code></span>

          <label class="pill" title="B·∫≠t/t·∫Øt ƒë·∫ßu ra BTS7960">
            <input type="checkbox" id="peltierEnable">
            Enable
          </label>

          <div class="controls">
            <button id="modeAuto" class="modebtn" type="button">Ch·∫ø ƒë·ªô t·ª± ƒë·ªông</button>
            <button id="modeManual" class="modebtn" type="button">Ch·∫ø ƒë·ªô th·ªß c√¥ng</button>
            <button id="modeOff" class="modebtn danger" type="button">T·∫ÆT</button>
          </div>

          <input id="peltierSlider" class="range" type="range" min="0" max="255" step="1" value="0"
            title="Duty 0..255 (manual)" />

          <span class="pill hidden">Duty: <b id="pelDutyLbl">0</b>/255 (<b id="pelPctLbl">0</b>%)</span>
          <span class="pill hidden">Mode: <b id="pelModeLbl">‚Äî</b></span>

          <span class="pill" title="AUTO: tƒÉng duty khi nhi·ªát ƒë·ªô > setpoint, gi·∫£m duty khi g·∫ßn setpoint ƒë·ªÉ ·ªïn ƒë·ªãnh">
            <span class="bandTag">Ng∆∞·ª°ng nhi·ªát ƒë·ªô t·ª± ƒë·ªông:</span>
            <span class="autoWrap">
              <label class="mono"> <input id="autoSetpoint" type="number" step="0.1"></label>
              <label class="mono hidden">Boost <input id="autoBoostBand" type="number" step="0.1"></label>
              <label class="mono hidden">Hys <input id="autoHys" type="number" step="0.1"></label>
              <label class="mono hidden">Min <input id="autoMinDuty" type="number" step="1" min="0" max="255"></label>
              <label class="mono hidden">Max <input id="autoMaxDuty" type="number" step="1" min="0" max="255"></label>
              <button id="autoApplyBtn" type="button" class="tabbtn small">√Åp d·ª•ng ch·∫ø ƒë·ªô t·ª± ƒë·ªông</button>
              <span class="autoHint hidden" id="autoExplain">‚Äî</span>
            </span>
          </span>

          <span class="pill"
            title="Ch·ªâ c·∫ßn nh·∫≠p LOW/HIGH. H·ªá th·ªëng t·ª± t·∫°o d·∫£i ALARM (¬±0.5) v√† CLEAR (¬±0.5) ƒë·ªÉ tr√°nh nh·∫•p nh√°y.">
            <span class="bandTag">Ng∆∞·ª°ng c·∫£nh b√°o:</span>
            <span class="bandWrap">
              <label class="mono">Th·∫•p <input id="rangeLowInput" type="number" step="0.1"></label>
              <label class="mono">Cao <input id="rangeHighInput" type="number" step="0.1"></label>
              <span class="pill" style="padding:6px 10px">Kho·∫£ng ch√™nh l·ªách: <b>0.5¬∞C</b></span>
              <button id="bandSaveBtn" type="button" class="tabbtn small">L∆∞u</button>
              <button id="bandDefaultBtn" type="button" class="tabbtn small">M·∫∑c ƒë·ªãnh ph√≤ng</button>
              <span class="pill hidden" style="padding:6px 10px" id="bandExplain">‚Äî</span>
            </span>
          </span>
        </div>

        <div class="stats">
          <div class="stat" aria-label="Nhi·ªát ƒë·ªô">
            <div class="statLabel">Nhi·ªát ƒë·ªô</div>
            <div class="statValue"><span id="tempBig">--.-</span></div>
            <div class="statUnit">¬∞C</div>
          </div>
          <div class="stat" aria-label="ƒê·ªô ·∫©m">
            <div class="statLabel">ƒê·ªô ·∫©m</div>
            <div class="statValue"><span id="humiBig">--.-</span></div>
            <div class="statUnit">%RH</div>
          </div>
        </div>

        <div class="toolbar" style="justify-content:flex-start;gap:8px;border-top:1px solid var(--border)">
          <span class="pill hidden">
            History points:
            <input id="histMax" type="number" value="1000" style="width:110px" disabled>
          </span>

          <span class="pill hidden">
            Kho·∫£ng hi·ªÉn th·ªã:
            <span class="mono"><b>24 gi·ªù</b></span>
          </span>

          <!-- B·ªô l·ªçc markers -->
          <label class="pill" title="Marker c·ª≠a OPEN/CLOSED tr√™n bi·ªÉu ƒë·ªì (b·∫≠t s·∫µn)">
            <input type="checkbox" id="chkDoorMarkers" checked>
            C·ª≠a
          </label>

          <label class="pill" title="Marker ALARM ON tr√™n bi·ªÉu ƒë·ªì (b·∫≠t s·∫µn)">
            <input type="checkbox" id="chkAlarmOnMarkers" checked>
            C·∫£nh b√°o b·∫≠t
          </label>

          <label class="pill" title="Marker ALARM OFF/CLEAR tr√™n bi·ªÉu ƒë·ªì (b·∫≠t s·∫µn)">
            <input type="checkbox" id="chkAlarmOffMarkers" checked>
            C·∫£nh b√°o t·∫Øt
          </label>

          <button id="histClear">Xo√° bi·ªÉu ƒë·ªì</button>
        </div>

        <div style="padding:12px;height:260px">
          <canvas id="thChart"></canvas>
        </div>
        <table aria-label="B·∫£ng nhi·ªát ƒë·ªô v√† ƒë·ªô ·∫©m" style="margin-top:14px" class="hidden">
          <thead>
            <tr>
              <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
              <th>ƒê·ªô ·∫©m (%RH)</th>
            </tr>
          </thead>
          <tbody id="roomTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ===== MODAL: B·∫£ng ghi T/H (theo t·ª´ng ph√≤ng) ===== -->
  <div id="thModalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="B·∫£ng ghi nhi·ªát ƒë·ªô v√† ƒë·ªô ·∫©m">
      <div class="modalHeader">
        <div class="modalTitle">üìã B·∫£ng ghi nhi·ªát ƒë·ªô & ƒë·ªô ·∫©m</div>
        <button class="modalClose" id="btnCloseTHModal">ƒê√≥ng ‚úï</button>
      </div>

      <div class="modalTools">
        <span class="pill">T·ªïng d√≤ng: <b id="thLogCount">0</b></span>
        <span class="pill">Ph√≤ng: <b id="thLogRoomLbl">room1</b></span>

        <span class="miniSwitch pill">
          <input type="checkbox" id="thLogEnable">
          <label for="thLogEnable">B·∫≠t ghi log</label>
        </span>

        <span class="pill">Gi·ªõi h·∫°n:
          <input id="thLogLimit" type="number" min="100" max="10000" value="2000" style="width:90px">
        </span>

        <input id="thLogSearch" placeholder="T√¨m theo th·ªùi gian" style="min-width:240px">

        <button id="btnTHExportCSV" class="primary">Xu·∫•t CSV</button>
        <button id="btnTHClear" class="danger">Xo√° log</button>
      </div>

      <div class="modalBody">
        <table class="tableMini" aria-label="B·∫£ng log T/H">
          <thead>
            <tr>
              <th style="width:22%">Th·ªùi gian</th>
              <th style="width:10%">Ph√≤ng</th>
              <th style="width:12%">Nhi·ªát ƒë·ªô (¬∞C)</th>
              <th style="width:12%">ƒê·ªô ·∫©m (%RH)</th>
              <th style="width:10%">C·ª≠a</th>
              <th style="width:14%">C·∫£nh b√°o</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="thLogTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="./WebDashboard_app.js"></script>
</body>

</html>